<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICMS - Instrument Calibration</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .card-compliance { transition: 0.3s; }
        .card-compliance:hover { transform: translateY(-5px); }
        .status-active { color: #198754; font-weight: bold; }
        .status-due { color: #ffc107; font-weight: bold; }
        .status-overdue { color: #dc3545; font-weight: bold; }
        .status-maintenance { color: #0d6efd; font-weight: bold; }
        
        /* Ensure Password Modal and Edit Modal are validly stacked */

        #editCalModal { z-index: 1070; }
    </style>
</head>
<body>

<!-- ... Nav ... --> 



<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container">
        <a class="navbar-brand" href="#">ICMS Dashboard</a>
        <div class="d-flex text-white">
            <span class="me-3 align-self-center">Welcome, <strong id="user-display">User</strong></span>
            <button class="btn btn-outline-light btn-sm" onclick="logout()">Log Out</button>
        </div>
    </div>
</nav>

<div class="container">
    
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-success card-compliance">
                <div class="card-body">
                    <h5 class="card-title">Calibrated</h5>
                    <h2 id="count-compliant">0 / 0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-dark bg-warning card-compliance">
                <div class="card-body">
                    <h5 class="card-title">Due Soon</h5>
                    <h2 id="count-due">0 / 0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-danger card-compliance">
                <div class="card-body">
                    <h5 class="card-title">Overdue</h5>
                    <h2 id="count-overdue">0 / 0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-primary card-compliance">
                <div class="card-body">
                    <h5 class="card-title">Maintenance</h5>
                    <h2 id="count-maintenance">0 / 0</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Actions & Filter -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Instrument Registry</h3>
        <div class="d-flex gap-2">
            <input type="text" id="searchInput" class="form-control" placeholder="Search instruments..." onkeyup="filterTable()">
            <button id="add-btn" class="btn btn-primary text-nowrap" data-bs-toggle="modal" data-bs-target="#newInstrumentModal">
                + New Instrument
            </button>
        </div>
    </div>

    <!-- Table -->
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Instrument ID</th>
                            <th>Instrument Name</th>
                            <th>Location</th>
                            <th>Last Cal</th>
                            <th>Next Due</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="instrument-table-body">
                        <!-- Rows loaded via JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<!-- New Instrument Modal -->
<div class="modal fade" id="newInstrumentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Register Instrument</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="newInstrumentForm">
                    <div class="mb-3">
                        <label>Instrument ID</label>
                        <input type="text" class="form-control" name="asset_tag" placeholder="e.g. PRD-301" required>
                    </div>
                    <div class="mb-3">
                        <label>Instrument Name</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label>Location</label>
                        <input type="text" class="form-control" name="location">
                    </div>
                    <div class="mb-3">
                        <label>Frequency (Months)</label>
                        <input type="number" class="form-control" name="frequency_months" value="12">
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Save</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Instrument Modal -->
<div class="modal fade" id="editInstrumentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Instrument</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editInstrumentForm">
                    <input type="hidden" name="id" id="edit_id">
                    <div class="mb-3">
                        <label>Instrument ID</label>
                        <input type="text" class="form-control" id="edit_asset_tag" disabled> 
                        <small class="text-muted">ID cannot be changed.</small>
                    </div>
                    <div class="mb-3">
                        <label>Instrument Name</label>
                        <input type="text" class="form-control" name="name" id="edit_name" required>
                    </div>
                    <div class="mb-3">
                        <label>Location</label>
                        <input type="text" class="form-control" name="location" id="edit_location">
                    </div>
                    <div class="mb-3">
                        <label>Status</label>
                        <select class="form-select" name="status" id="edit_status">
                            <option value="Active">Active</option>
                            <option value="Due">Due</option>
                            <option value="Maintenance">Maintenance</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>Frequency (Months)</label>
                        <input type="number" class="form-control" name="frequency_months" id="edit_frequency">
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Update</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Calibration Modal -->
<div class="modal fade" id="calibrationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Log Calibration Event</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="calibrationForm">
                    <input type="hidden" name="instrument_id" id="cal_instrument_id">
                    <div class="mb-3">
                        <label>Date</label>
                        <input type="date" class="form-control" name="calibration_date" required id="cal_date_input">
                    </div>
                    <div class="mb-3">
                        <label>Calibrated By</label>
                        <input type="text" class="form-control" name="calibrated_by" placeholder="Agency or Technician Name">
                    </div>
                    <div class="mb-3">
                        <label>Certificate No</label>
                        <input type="text" class="form-control" name="certificate_no" placeholder="e.g. CERT-2025-001">
                    </div>
                    <div class="mb-3">
                        <label>Next Due Date</label>
                        <input type="date" class="form-control" name="next_due_date" id="cal_next_due_input">
                    </div>
                    <div class="mb-3">
                        <label>Status</label>
                        <select class="form-select" name="pass_fail_status">
                            <option value="Pass">Compliant</option>
                            <option value="Fail">Non-Compliant</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>Certificate (PDF)</label>
                        <input type="file" class="form-control" name="certificate_file" accept=".pdf,.jpg,.png" required>
                    </div>
                    <button type="submit" class="btn btn-success w-100">Submit Certification</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Calibration Modal -->
<div class="modal fade" id="editCalModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Calibration Log</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editCalForm">
                    <input type="hidden" name="action" value="update">
                    <input type="hidden" name="id" id="ecal_id">
                    <div class="mb-3">
                        <label>Date</label>
                        <input type="date" class="form-control" name="calibration_date" id="ecal_date" required>
                    </div>
                    <div class="mb-3">
                        <label>Calibrated By</label>
                        <input type="text" class="form-control" name="calibrated_by" id="ecal_by" required>
                    </div>
                    <div class="mb-3">
                        <label>Certificate No</label>
                        <input type="text" class="form-control" name="certificate_no" id="ecal_cert" required>
                    </div>
                    <div class="mb-3">
                        <label>Next Due Date</label>
                        <input type="date" class="form-control" name="next_due_date" id="ecal_next_due">
                    </div>
                    <div class="mb-3">
                        <label>Status</label>
                        <select class="form-select" name="pass_fail_status" id="ecal_status">
                            <option value="Pass">Pass</option>
                            <option value="Fail">Fail</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>Update Certificate (Optional)</label>
                        <input type="file" class="form-control" name="certificate_file" accept=".pdf,.jpg,.png">
                        <small class="text-muted">Leave blank to keep current certificate.</small>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Update Log</button>
                </form>
            </div>
        </div>
    </div>
</div>



<!-- History Modal -->
<div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Calibration History</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <table class="table table-sm align-middle">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Calibrated By</th>
                            <th>Cert. No.</th>
                            <th>Status</th>
                            <th>Link</th>
                            <th id="actions-header">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- QR Code Modal -->
<div class="modal fade" id="qrModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">QR Code</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div id="qrcode" class="d-flex justify-content-center mb-3"></div>
                <p id="qr-tag-display" class="fw-bold"></p>
                <a id="public-link" href="#" target="_blank" class="btn btn-link btn-sm">Open Public Page</a>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API_URL = 'api/instruments.php';
    let allInstruments = [];
    const userRole = localStorage.getItem('user_role');

    // Check Auth
    if (!userRole) {
        window.location.href = 'login.html';
    }

    document.addEventListener('DOMContentLoaded', () => {
        // UI Adjustments based on role
        if (userRole !== 'admin') {
            document.getElementById('add-btn').style.display = 'none';
        }
        document.getElementById('user-display').textContent = localStorage.getItem('user_name') || 'User';

        loadInstruments();
        document.getElementById('cal_date_input').valueAsDate = new Date();
    });

    // Logout
    function logout() {
        localStorage.clear();
        window.location.href = 'login.html';
    }

    // Fetch and Render
    function loadInstruments() {
        fetch(API_URL)
            .then(res => res.json())
            .then(data => {
                allInstruments = data;
                renderTable(data);
                updateStats(data);
            });
    }

    function updateStats(data) {
        let compliant = 0, overdue = 0, due = 0, maintenance = 0;
        const total = data.length;
        
        data.forEach(inst => {
            if (inst.is_overdue) overdue++;
            else if (inst.status === 'Due') due++; 
            else if (inst.status === 'Active') compliant++;
            else if (inst.status === 'Maintenance') maintenance++;
        });
        
        document.getElementById('count-compliant').textContent = `${compliant} / ${total}`;
        document.getElementById('count-overdue').textContent = `${overdue} / ${total}`;
        document.getElementById('count-due').textContent = `${due} / ${total}`;
        document.getElementById('count-maintenance').textContent = `${maintenance} / ${total}`;
    }

    function renderTable(data) {
        const tbody = document.getElementById('instrument-table-body');
        tbody.innerHTML = '';
        
        data.forEach(inst => {
            const row = document.createElement('tr');
            
            let statusClass = 'text-success status-active';
            let statusText = inst.status;
            
            if (inst.is_overdue) {
                statusClass = 'text-danger fw-bold status-overdue';
                statusText += ' (OVERDUE)';
            } else if (inst.status === 'Due') {
                statusClass = 'text-warning fw-bold status-due';
            } else if (inst.status === 'Maintenance') {
                statusClass = 'text-primary fw-bold status-maintenance';
            }

            let actions = `
                <button class="btn btn-sm btn-outline-info" onclick="openHistory(${inst.id}, '${inst.asset_tag}')" title="History">üìú</button>
                <button class="btn btn-sm btn-outline-dark" onclick="openQR('${inst.asset_tag}')" title="Scan QR Code" style="min-width: 40px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-qr-code" viewBox="0 0 16 16">
                        <path d="M2 2h2v2H2V2Z"/>
                        <path d="M6 0v6H0V0h6ZM5 1H1v4h4V1ZM4 12H2v2h2v-2Z"/>
                        <path d="M6 10v6H0v-6h6Zm-5 1v4h4v-4H1Zm11-9h2v2h-2V2Z"/>
                        <path d="M10 0v6h6V0h-6Zm5 1v4h-4V1h4ZM8 1V0h1v2H8v2H7V1h1Zm0 5V4h1v2H8ZM6 8V7h1V6h1v2h1V7h5v1h-4v1H7V8H6Zm0 0v1H2V8H1v1H0V7h3v1h3Zm10 1h-1V7h1v2Zm-1 0h-1v2h2v-2h-1Zm-4 0h2v1h-1v1h-1V9Zm2 3v-1h-1v1h-1v1H9v1h3v-2h1Zm0 0h3v1h-2v1h-1v-2Zm-4-1v1h1v-2H7v1h2Z"/>
                        <path d="M7 12h1v3h4v1H7v-4Zm9 2v2h-3v-1h2v-1h1Z"/>
                    </svg>
                </button>
            `;

            if (userRole === 'admin') {
                actions = `
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-primary" onclick="openCalModal(${inst.id})" title="Add Calibration">+</button>
                        ${actions}
                        <button class="btn btn-sm btn-outline-secondary" onclick='openEdit(${JSON.stringify(inst)})' title="Edit">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteInstrument(${inst.id})" title="Delete">üóëÔ∏è</button>
                    </div>
                `;
            } else {
                 actions = `<div class="btn-group">${actions}</div>`;
            }

            row.innerHTML = `
                <td><strong>${inst.asset_tag}</strong></td>
                <td>${inst.name}</td>
                <td>${inst.location || '-'}</td>
                <td>${inst.last_calibration_date || '-'}</td>
                <td>${inst.next_calibration_date || 'N/A'}</td>
                <td class="${statusClass}">${statusText}</td>
                <td>${actions}</td>
            `;
            tbody.appendChild(row);
        });
    }

    // Filter
    function filterTable() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allInstruments.filter(inst => 
            inst.asset_tag.toLowerCase().includes(term) || 
            inst.name.toLowerCase().includes(term) ||
            (inst.location && inst.location.toLowerCase().includes(term))
        );
        renderTable(filtered);
    }
    
    // ... existings functions (New Instrument, Edit, Calibration, Delete) ...

    // New Instrument
    document.getElementById('newInstrumentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(this));
        
        fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(res => res.json())
        .then(res => {
            if(res.error) alert(res.error);
            else {
                bootstrap.Modal.getInstance(document.getElementById('newInstrumentModal')).hide();
                loadInstruments();
                this.reset();
            }
        });
    });

    // Update Instrument (Edit)
    document.getElementById('editInstrumentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(this));
        
        fetch(API_URL, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(res => res.json())
        .then(res => {
            if(res.error) alert(res.error);
            else {
                alert('Updated!');
                bootstrap.Modal.getInstance(document.getElementById('editInstrumentModal')).hide();
                loadInstruments();
            }
        });
    });

    // Delete Instrument
    window.deleteInstrument = function(id) {
        if(!confirm('Are you sure you want to delete this instrument? This cannot be undone.')) return;
        
        fetch(API_URL, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({id: id})
        })
        .then(res => res.json())
        .then(res => {
            if(res.error) alert(res.error);
            else {
                loadInstruments();
            }
        });
    }

    // Calibration Log
    document.getElementById('calibrationForm').addEventListener('submit', function(e) {
        e.preventDefault();
        fetch('api/calibrations.php', { method: 'POST', body: new FormData(this) })
        .then(res => res.json())
        .then(res => {
            if(res.error) alert('Error: ' + res.error);
            else {
                alert('Calibration logged!');
                bootstrap.Modal.getInstance(document.getElementById('calibrationModal')).hide();
                loadInstruments();
                this.reset();
            }
        });
    });

    // Modals
    window.openCalModal = function(id) {
        document.getElementById('cal_instrument_id').value = id;
        
        // Calculate default Next Due based on Today + Frequency
        const inst = allInstruments.find(i => i.id == id);
        if(inst) {
            const freq = parseInt(inst.frequency_months) || 12;
            const today = new Date();
            today.setMonth(today.getMonth() + freq);
            document.getElementById('cal_next_due_input').valueAsDate = today;
        }

        new bootstrap.Modal(document.getElementById('calibrationModal')).show();
    }

    window.openEdit = function(inst) {
        document.getElementById('edit_id').value = inst.id;
        document.getElementById('edit_asset_tag').value = inst.asset_tag;
        document.getElementById('edit_name').value = inst.name;
        document.getElementById('edit_location').value = inst.location;
        document.getElementById('edit_status').value = inst.status;
        document.getElementById('edit_frequency').value = inst.frequency_months || 12;
        new bootstrap.Modal(document.getElementById('editInstrumentModal')).show();
    }




    // New/Update Log Handlers
    function editLog(logId) {
        const log = currentLogsMap[logId];
        if(!log) return alert('Error: Log not found');

        document.getElementById('ecal_id').value = log.id;
        document.getElementById('ecal_date').value = log.calibration_date;
        document.getElementById('ecal_by').value = log.calibrated_by;
        document.getElementById('ecal_cert').value = log.certificate_no;
        
        // Try to find current next due from parent instrument to pre-fill?
        // Actually, log doesn't store next_due. We can leave it blank or fetch parent?
        // Simple approach: leave blank or let user set it if they want to override current instrument status.
        // Better: Find the instrument and show its *current* next due date.
        const inst = allInstruments.find(i => i.id == log.instrument_id);
        if(inst) {
             document.getElementById('ecal_next_due').value = inst.next_calibration_date;
        }
        document.getElementById('ecal_status').innerHTML = `
            <option value="Compliant" ${log.pass_fail_status === 'Compliant' ? 'selected' : ''}>Compliant</option>
            <option value="Non-Compliant" ${log.pass_fail_status === 'Non-Compliant' ? 'selected' : ''}>Non-Compliant</option>
        `;
        document.getElementById('ecal_status').value = log.pass_fail_status;
        new bootstrap.Modal(document.getElementById('editCalModal')).show();
    }

    function deleteLog(id) {
        if(!confirm('Permanently delete this record?')) return;
        
        fetch('api/calibrations.php', {
            method: 'DELETE',
            body: JSON.stringify({id: id})
        })
        .then(res => res.json())
        .then(res => {
            if(res.error) {
                alert('Error: ' + res.error);
            } else {
                alert(res.message);
                // Force close history modal to require re-opening (simple way to refresh)
                bootstrap.Modal.getInstance(document.getElementById('historyModal')).hide();
                loadInstruments();
            }
        })
        .catch(err => alert('Request Failed: ' + err));
    }


    let currentLogsMap = {};

    // Update Log Submit
    document.getElementById('editCalForm').addEventListener('submit', function(e) {
        e.preventDefault();
        fetch('api/calibrations.php', { method: 'POST', body: new FormData(this) })
        .then(res => res.json())
        .then(res => {
            alert(res.message);
            bootstrap.Modal.getInstance(document.getElementById('editCalModal')).hide();
            bootstrap.Modal.getInstance(document.getElementById('historyModal')).hide();
            loadInstruments();
        });
    });

    window.openHistory = function(id, assetTag) {
        const titleEl = document.querySelector('#historyModal .modal-title');
        titleEl.innerHTML = `Calibration History <span class="badge bg-primary ms-2">${assetTag}</span>`;
        
        // Toggle Header
        const headerEl = document.getElementById('actions-header');
        if(userRole === 'admin') headerEl.style.display = '';
        else headerEl.style.display = 'none';

        fetch(`api/calibrations.php?instrument_id=${id}`)
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById('history-table-body');
                tbody.innerHTML = '';
                currentLogsMap = {}; 

                if(data.length === 0) {
                    const colSpan = userRole === 'admin' ? 6 : 5;
                    tbody.innerHTML = `<tr><td colspan="${colSpan}" class="text-center">No history found</td></tr>`;
                }
                data.forEach(log => {
                    currentLogsMap[log.id] = log; 

                    let actionsTd = '';
                    if(userRole === 'admin') {
                        actionsTd = `<td>
                            <button class="btn btn-sm btn-outline-secondary me-1" onclick="editLog(${log.id})">‚úèÔ∏è</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteLog(${log.id})">üóëÔ∏è</button>
                        </td>`;
                    }

                    let badge = log.pass_fail_status === 'Compliant' 
                        ? '<span class="badge bg-success">Compliant</span>' 
                        : '<span class="badge bg-danger">Non-Compliant</span>';

                    const row = `<tr>
                        <td>${log.calibration_date}</td>
                        <td>${log.calibrated_by || '-'}</td>
                        <td>${log.certificate_no || '-'}</td>
                        <td>${badge}</td>
                        <td><a href="${log.certificate_file}" target="_blank">View</a></td>
                        ${actionsTd}
                    </tr>`;
                    tbody.innerHTML += row;
                });
                new bootstrap.Modal(document.getElementById('historyModal')).show();
            });
    }

    window.openQR = function(tag) {
        const qrContainer = document.getElementById('qrcode');
        qrContainer.innerHTML = ''; 
        document.getElementById('qr-tag-display').textContent = tag;
        
        // Use current host
        const url = `${window.location.protocol}//${window.location.host}${window.location.pathname.replace('index.html','')}scan.html?tag=${tag}`;
        document.getElementById('public-link').href = url;
        
        new QRCode(qrContainer, {
            text: url,
            width: 128,
            height: 128
        });
        
        new bootstrap.Modal(document.getElementById('qrModal')).show();
    }
</script>
</body>
</html>
