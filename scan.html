<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instrument Public Scan</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #e9ecef; display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .card-scan { max-width: 400px; width: 100%; border-radius: 15px; overflow: hidden; }
        .status-header { padding: 20px; text-align: center; color: white; }
        .valid { background-color: #198754; }
        .invalid { background-color: #dc3545; }
    </style>
</head>
<body>

<div class="card shadow card-scan">
    <div id="status-header" class="status-header">
        <h1 id="icon"></h1>
        <h3 id="status-text">Loading...</h3>
    </div>
    <div class="card-body">
        <h5 class="card-title text-center mb-4" id="instrument-name"></h5>
        
        <ul class="list-group list-group-flush">
            <li class="list-group-item d-flex justify-content-between">
                <span>Equipment ID:</span>
                <strong id="asset-tag">---</strong>
            </li>
            <li class="list-group-item d-flex justify-content-between">
                <span>Location:</span>
                <strong id="location">---</strong>
            </li>
            <li class="list-group-item d-flex justify-content-between">
                <span>Last Calibration:</span>
                <strong id="last-cal">---</strong>
            </li>
            <li class="list-group-item d-flex justify-content-between">
                <span>Calibrated By:</span>
                <strong id="cal-by">---</strong>
            </li>
            <li class="list-group-item d-flex justify-content-between">
                <span>Certificate No:</span>
                <strong id="cert-no">---</strong>
            </li>
            <li class="list-group-item d-flex justify-content-between">
                <span>Next Due:</span>
                <strong id="next-due">---</strong>
            </li>
        </ul>

        <div class="mt-4 text-center">
            <small class="text-muted">Last synced: <span id="synced-time"></span></small>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const params = new URLSearchParams(window.location.search);
        const tag = params.get('tag');

        if (!tag) {
            showError("No Equipment ID Provided");
            return;
        }

        fetch(`api/public_scan.php?tag=${tag}`)
            .then(res => {
                if (!res.ok) throw new Error("Instrument Not Found");
                return res.json();
            })
            .then(data => {
                document.getElementById('instrument-name').textContent = data.name;
                document.getElementById('asset-tag').textContent = data.asset_tag;
                document.getElementById('location').textContent = data.location || 'N/A';
                document.getElementById('last-cal').innerText = data.last_cal_date || 'N/A';
                document.getElementById('cal-by').innerText = data.calibrated_by || 'N/A';
                document.getElementById('cert-no').innerText = data.certificate_no || 'N/A';
                document.getElementById('next-due').innerText = data.next_due || 'N/A';

                if (data.latest_cert) {
                    const link = document.createElement('a');
                    link.href = data.latest_cert;
                    link.target = '_blank';
                    link.className = 'btn btn-outline-primary btn-sm mt-2 w-100';
                    link.innerText = 'View Calibration Certificate';
                    document.getElementById('last-cal').parentNode.after(link);
                }

                document.getElementById('synced-time').textContent = data.last_updated;

                const header = document.getElementById('status-header');
                const statusText = document.getElementById('status-text');
                const icon = document.getElementById('icon');

                if (data.valid_calibration) {
                    header.classList.add('valid');
                    statusText.textContent = "COMPLIANT";
                    icon.innerHTML = "&#10003;"; // Checkmark
                } else {
                    header.classList.add('invalid');
                    statusText.textContent = "NOT COMPLIANT";
                    icon.innerHTML = "&#9888;"; // Warning
                }
            })
            .catch(err => {
                showError(err.message);
            });
    });

    function showError(msg) {
        document.getElementById('status-header').classList.add('invalid');
        document.getElementById('status-text').textContent = "ERROR";
        document.getElementById('instrument-name').textContent = msg;
    }
</script>

</body>
</html>
