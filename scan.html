<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instrument Public Scan</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        body { background-color: #e9ecef; display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .card-scan { max-width: 400px; width: 100%; border-radius: 15px; overflow: hidden; }
        .status-header { padding: 20px; text-align: center; color: white; }
        .valid { background-color: #198754; }
        .invalid { background-color: #dc3545; }

        /* Secure View Styling */
        #pdf-render-container {
            max-height: 80vh;
            overflow-y: auto;
            background: #525659;
            text-align: center;
            padding: 20px;
            user-select: none; /* Prevent text selection */
            -webkit-user-select: none;
        }
        canvas.pdf-page {
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            max-width: 100%;
        }
        /* Anti-Print */
        @media print {
            #certModal, .modal-backdrop { display: none !important; }
            body { display: none !important; }
        }
    </style>
</head>
<body>

<div class="card shadow card-scan">
    <div id="status-header" class="status-header">
        <h1 id="icon"></h1>
        <h3 id="status-text">Loading...</h3>
    </div>
    <div class="card-body">
        <h5 class="card-title text-center mb-4" id="instrument-name"></h5>
        
        <ul class="list-group list-group-flush">
            <li class="list-group-item d-flex justify-content-between">
                <span>Equipment ID:</span>
                <strong id="asset-tag">---</strong>
            </li>
            <li class="list-group-item d-flex justify-content-between">
                <span>Location:</span>
                <strong id="location">---</strong>
            </li>
            <li class="list-group-item d-flex justify-content-between">
                <span>Last Calibration:</span>
                <strong id="last-cal">---</strong>
            </li>
            <li class="list-group-item d-flex justify-content-between">
                <span>Calibrated By:</span>
                <strong id="cal-by">---</strong>
            </li>
            <li class="list-group-item d-flex justify-content-between">
                <span>Certificate No:</span>
                <strong id="cert-no">---</strong>
            </li>
            <li class="list-group-item d-flex justify-content-between">
                <span>Next Due:</span>
                <strong id="next-due">---</strong>
            </li>
        </ul>

        <div class="mt-4 text-center">
            <small class="text-muted">Last synced: <span id="synced-time"></span></small>
        </div>
        <div id="view-btn-container" class="mt-3"></div>
    </div>
</div>

<!-- Certificate Viewer Modal -->
<div class="modal fade" id="certModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content bg-dark">
            <div class="modal-header border-0">
                <h5 class="modal-title text-white">Certificate Viewer (Read Only)</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0" id="pdf-render-container">
                <!-- PDF Canvases will be rendered here -->
                <div class="text-white mt-5">Loading Secure Viewer...</div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const params = new URLSearchParams(window.location.search);
        const tag = params.get('tag');

        if (!tag) {
            showError("No Equipment ID Provided");
            return;
        }

        // Prevent Right Click globally on this page (User request: prevent screenshot/copy logic)
        document.addEventListener('contextmenu', event => event.preventDefault());
        
        // Prevent Print Screen key (attempt)
        document.addEventListener('keyup', (e) => {
            if (e.key == 'PrintScreen') {
                navigator.clipboard.writeText('');
                alert('Screenshots are disabled on this page.');
            }
        });

        fetch(`api/public_scan.php?tag=${tag}`)
            .then(res => {
                if (!res.ok) throw new Error("Instrument Not Found");
                return res.json();
            })
            .then(data => {
                document.getElementById('instrument-name').textContent = data.name;
                document.getElementById('asset-tag').textContent = data.asset_tag;
                document.getElementById('location').textContent = data.location || 'N/A';
                document.getElementById('last-cal').innerText = data.last_cal_date || 'N/A';
                document.getElementById('cal-by').innerText = data.calibrated_by || 'N/A';
                document.getElementById('cert-no').innerText = data.certificate_no || 'N/A';
                document.getElementById('next-due').innerText = data.next_due || 'N/A';

                if (data.latest_cert) {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-primary w-100';
                    btn.innerText = 'View Calibration Certificate';
                    btn.onclick = () => openCertViewer(data.latest_cert);
                    document.getElementById('view-btn-container').appendChild(btn);
                }

                document.getElementById('synced-time').textContent = data.last_updated;

                const header = document.getElementById('status-header');
                const statusText = document.getElementById('status-text');
                const icon = document.getElementById('icon');

                if (data.valid_calibration) {
                    header.classList.add('valid');
                    statusText.textContent = "COMPLIANT";
                    icon.innerHTML = "&#10003;"; // Checkmark
                } else {
                    header.classList.add('invalid');
                    statusText.textContent = "NOT COMPLIANT";
                    icon.innerHTML = "&#9888;"; // Warning
                }
            })
            .catch(err => {
                showError(err.message);
            });
    });

    async function openCertViewer(url) {
        const modal = new bootstrap.Modal(document.getElementById('certModal'));
        modal.show();
        
        const container = document.getElementById('pdf-render-container');
        container.innerHTML = '<div class="text-white mt-5">Loading Secure Document...</div>';

        try {
            const loadingTask = pdfjsLib.getDocument(url);
            const pdf = await loadingTask.promise;
            
            container.innerHTML = ''; // Clear loading

            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                const page = await pdf.getPage(pageNum);
                
                // Adjust scale for mobile/desktop
                const viewport = page.getViewport({scale: 1.5});
                
                const canvas = document.createElement('canvas');
                canvas.className = 'pdf-page';
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                // Disable right click on canvas specifically
                canvas.addEventListener('contextmenu', e => e.preventDefault());

                container.appendChild(canvas);

                const renderContext = {
                    canvasContext: context,
                    viewport: viewport
                };
                await page.render(renderContext).promise;
            }
        } catch (error) {
            console.error(error);
            container.innerHTML = '<div class="text-danger mt-5">Error loading document. Please try again.</div>';
        }
    }

    function showError(msg) {
        document.getElementById('status-header').classList.add('invalid');
        document.getElementById('status-text').textContent = "ERROR";
        document.getElementById('instrument-name').textContent = msg;
    }
</script>

</body>
</html>
